# 订单系统与支付 API 集成指南

根据提供的后端 API 文档，我们已经完成了前端订单系统的开发，包括订单列表、订单详情、创建订单、支付和退款功能。本指南提供了集成说明以帮助您理解和使用这些组件。

## 项目结构

```
app/
├── services/
│   └── api-service.ts      # API服务层，封装所有API请求
├── components/
│   └── orders/
│       ├── order-list.tsx        # 订单列表组件
│       ├── order-detail.tsx      # 订单详情组件
│       ├── create-order.tsx      # 创建订单组件
│       ├── payment-page.tsx      # 支付页面组件
│       ├── refund-form.tsx       # 退款表单组件
│       ├── order-status-badge.tsx # 订单状态徽章组件
│       └── payment-method-badge.tsx # 支付方式徽章组件
├── dashboard/
│   ├── orders/
│   │   ├── page.tsx              # 订单列表页面
│   │   ├── [orderId]/page.tsx    # 订单详情页面
│   │   └── create/page.tsx       # 创建订单页面
│   ├── payment/
│   │   └── [orderId]/page.tsx    # 支付页面
│   └── refunds/
│       └── create/page.tsx       # 创建退款页面
└── api/
    └── payment/
        └── pay/route.ts          # 支付重定向API路由
```

## 环境配置

1. 创建 `.env.local` 文件并设置必要的环境变量：
   ```
   NEXT_PUBLIC_API_URL=http://localhost:8000/api
   NEXT_PUBLIC_APP_URL=http://localhost:3000
   ```

2. 确保后端API服务器已经启动并正确配置，包括：
   - 支付宝和微信支付的配置
   - 跨域设置允许前端访问

## 主要功能说明

### 1. 订单列表 (OrderList)

- 显示当前用户的所有订单
- 支持按订单状态筛选
- 支持按订单号/商品名称搜索
- 支持按不同字段排序
- 提供快捷操作按钮（查看详情、支付、退款）

### 2. 订单详情 (OrderDetail)

- 显示订单的详细信息
- 支持刷新订单状态
- 根据订单状态提供不同操作按钮（支付、退款）
- 显示退款信息（如果有）

### 3. 创建订单 (CreateOrder)

- 提供表单创建新订单
- 支持选择支付方式（微信支付或支付宝）
- 创建成功后跳转到支付页面

### 4. 支付页面 (PaymentPage)

- 根据订单的支付方式提供对应的支付选项
- 微信支付：获取支付参数，支持扫码支付（Native）或H5支付
- 支付宝：提供表单支付方式
- 支持检查支付状态

### 5. 退款申请 (RefundForm)

- 为已支付的订单提供退款申请表单
- 支持全额或部分退款
- 要求填写退款原因

## 数据流

1. **订单创建流程**：
   ```
   CreateOrder组件 
   -> 调用orderApi.createOrder 
   -> 获取订单ID 
   -> 跳转到支付页面
   ```

2. **支付流程**：
   ```
   PaymentPage组件 
   -> 根据支付方式调用相应API（微信/支付宝） 
   -> 获取支付参数 
   -> 引导用户完成支付 
   -> 通过checkPaymentStatus检查支付状态
   ```

3. **退款流程**：
   ```
   RefundForm组件 
   -> 提交退款申请 
   -> 调用orderApi.createRefund 
   -> 跳转回订单详情页
   ```

## 用户认证集成

当前实现使用了简化的用户认证方式，从localStorage获取用户信息。在实际项目中，您应该：

1. 使用更安全的认证机制（如JWT或OAuth）
2. 实现完整的登录/登出功能
3. 保护需要认证的路由

## 支付集成注意事项

### 微信支付

1. **JSAPI支付**：需要在微信内使用，并且需要用户的openid
2. **Native支付**：生成二维码让用户扫码支付
3. **H5支付**：通过重定向到mweb_url让用户在H5页面完成支付

### 支付宝支付

1. **表单提交方式**：通过提交表单到支付宝网关完成支付
2. **回调处理**：需要正确配置return_url以便用户支付完成后跳转回应用

## 常见问题和解决方案

1. **支付无法完成**
   - 检查环境变量是否正确配置
   - 确认后端服务器可以正常访问
   - 检查支付参数是否正确

2. **订单状态未更新**
   - 使用"刷新状态"按钮手动查询最新状态
   - 确认支付平台异步通知是否正确配置

3. **退款失败**
   - 检查退款金额是否超过原订单金额
   - 确认订单状态是否为"已支付"

## 扩展和优化建议

1. **实现WebSocket**：实时更新订单状态，无需手动刷新
2. **增加分页功能**：对大量订单进行分页显示
3. **导出功能**：支持将订单数据导出为CSV/Excel
4. **批量操作**：支持批量退款或取消订单
5. **统计分析**：添加订单统计和数据分析功能